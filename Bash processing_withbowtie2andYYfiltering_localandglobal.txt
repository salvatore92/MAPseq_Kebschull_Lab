

#Give name for your experiment
Prefix='DAT-1'


#Check whether the fastq.gz file name fits the below script
# this script is doing specific filtering in "grep -E '^(.{30}[TC][TC]|.{29}[TC][TC]G)'", similar to YY filtering
as my sequence should have specific sequences at 30-32 or 29-32, which should be adjusted depending on your virus library 

for i in {6..6} {17..17} {34..34} {37..37} {39..39} {73..73};do
zcat raw/${Prefix}-${i}_*_L00[0-9]_R1_001.fastq.gz | awk "NR%4==2" | cut -b 1-32 > ${Prefix}_${i}_R1_stripped.txt
zcat raw/${Prefix}-${i}_*_L00[0-9]_R2_001.fastq.gz | awk "NR%4==2" | cut -b 1-20 | paste -d '' ${Prefix}_${i}_R1_stripped.txt - | grep -v N | grep -E '^(.{30}[TC][TC]|.{29}[TC][TC]G)' > ${Prefix}_BC${i}_PE.txt
cut -b 45-52 ${Prefix}_BC${i}_PE.txt | sort | uniq -c | sort -nr > ${Prefix}_BC${i}_SSIcheck.txt
echo ${i}
head -5 ${Prefix}_BC${i}_SSIcheck.txt
done


#make SSI txt files first

for i in {6..6} {17..17} {34..34} {37..37} {39..39} {73..73};do
awk "NR==${i}" SSI.txt > SSI
C=$(cut -b 1-8 SSI)
grep "$C"$ ${Prefix}_BC${i}_PE.txt | cut -b 1-44 | sort | uniq -c | sort -nr > ${Prefix}_BC${i}_BU.txt
awk '{print $1}' ${Prefix}_BC${i}_BU.txt > ${Prefix}_BC${i}_BU_counts.txt
awk '{print $2}' ${Prefix}_BC${i}_BU.txt > ${Prefix}_BC${i}_BU_seq.txt
done


#Determine threshold using rankplot2.m in matlab (keeping only sequences in "plateau"

mkdir thresholds
cd thresholds

#Set the first position as 0 and give your thresholds from the second position, for example, threshold=(0 3 3 3 3 3 3 3 3)

#do a quick collpase around the UMI tags
for i in {6..6} {17..17} {34..34} {37..37} {39..39} {73..73};do
    j=${threshold[$i]} 
    echo ${j}
    if [ "$j" != "1" ];then
	awk '$1 < '$j' {print NR}' ../${Prefix}_BC${i}_BU_counts.txt | head -1 >t
	thresh=$(cat t)
	echo $thresh
	head ../${Prefix}_BC${i}_BU_seq.txt -n $thresh | cut -b 1-32 | sort | uniq -c | sort -nr > ${Prefix}_BC${i}_quickout.txt
   else
	cut -b 1-32 ../${Prefix}_BC${i}_BU_seq.txt | sort | uniq -c | sort -nr > ${Prefix}_BC${i}_quickout.txt
   fi
done



#ok, thats a lot of preprocessing done. Now we have to error correct these sequences. The all against all mapping of barcodes in using bowtie is done in the command line. after this we move into MATLAB.

# this script suppose that you used L4 spikein, if you didn't you should change the sequence 'CGTC' in the below script as your spikein 


# in the "pre" folder, do local collapsing

mkdir pre
cd pre

mkdir preindexes

NVAL=1   #this is to allow 1 mismatch in bowtie2 seedmatichg
LVAL=16 #this is seed length for bowtie2

for i in {1..17} {19..83} {85..85};do
echo ${i}
awk '{print $1}' ../${Prefix}_BC${i}_quickout.txt > ${Prefix}_pre${i}_counts.txt
awk '{print $2}' ../${Prefix}_BC${i}_quickout.txt > ${Prefix}_pre${i}_seq.txt
nl ${Prefix}_pre${i}_seq.txt | awk '{print ">" $1 "\n" $2}' > ${Prefix}_pre${i}fasta2u.txt
bowtie2-build ${Prefix}_pre${i}fasta2u.txt preindexes/${i}fasta2u
 u > bowtie2_build.log 2>&1
bowtie2 -D 20 -R 3 -N ${NVAL} -L ${LVAL} -i S,1,1.15 --score-min L,0,-0.7 -p 36 -a \
-x "preindexes/${i}fasta2u" \
-f -U "${Prefix}_pre${i}fasta2u.txt" \
--no-head -S "prealignment${i}_L${LVAL}_N${NVAL}.sam"
awk '{print $1}' prealignment${i}_L${LVAL}_N${NVAL}.sam > bowtiepre${i}_2u_1.txt
awk '{print $3}' prealignment${i}_L${LVAL}_N${NVAL}.sam > bowtiepre${i}_2u_3.txt
done


#In Matlab, go to thresholds directory and run produceBCmat2_nospikes (e.g. produceBCmat2_nospikes(1:85,'DAT-1','')   )
#It will generate ${Prefix}_BCglobal_quickout.txt for global collapsing
#bowtie${i}_2u_1 and bowtie${i}_2u_3 are also generated, which assign each seq of each file to the global  


cd ..

awk '{print $1}' ${Prefix}_BCglobal_quickout.txt > ${Prefix}_global_counts.txt
awk '{print $2}' ${Prefix}_BCglobal_quickout.txt > ${Prefix}_global_seq.txt
nl ${Prefix}_global_seq.txt | awk '{print ">" $1 "\n" $2}' > ${Prefix}_globalfasta2u.txt
bowtie2-build ${Prefix}_globalfasta2u.txt indexes/globalfasta2u > bowtie2_build.log 2>&1
bowtie2 -D 20 -R 3 -N ${NVAL} -L ${LVAL} -i S,1,1.15 --score-min L,0,-0.6 -p 36 -a \
-x "indexes/globalfasta2u" \
-f -U "${Prefix}_globalfasta2u.txt" \
--no-head -S "alignmentglobal_L${LVAL}_N${NVAL}.sam"
awk '{print $1}' alignmentglobal_L${LVAL}_N${NVAL}.sam > bowtieglobal_2u_1.txt
awk '{print $3}' alignmentglobal_L${LVAL}_N${NVAL}.sam > bowtieglobal_2u_3.txt



#In Matlab, go to one above thresholds directory and run produceBCmat3 (e.g. produceBCmat3(1:85,'DAT-1','CGTCAGTC','')  )

